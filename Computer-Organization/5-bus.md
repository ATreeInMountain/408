# 总线

![image-20250315175952640](imgs\image-20250315175952640.png)

* CPU、主存、硬盘、打印机，都分别和 **地址总线，数据总线，控制总线** 有连接
* 每个总线可能有**多根信号线组成**

![image-20250315175931366](imgs\image-20250315175931366.png)

* 一根总线有 n 条信号线，则同一时刻总线可以传输 n bit 数据
* 一根总线，同一时刻只允许**一个部件发送**，但允许**多个部件接受**

![image-20250315180306543](imgs\image-20250315180306543.png)

* 计算机上接口，总线是提前在主板上布置好的

  CPU、主存只需要插入，就能连接

## 概述

### 基本概念

![image-20250315180900061](imgs\image-20250315180900061.png)

* 总线是星型拓扑的进化(节省了电线)
* 总线是 **分时、共享** 的

![image-20250315181047474](imgs\image-20250315181047474.png)

* 设计总线时需要关注的四大特性 —— 机械特性、电气特性、功能特性、时间特性

### 总线分类

![image-20250317182903302](imgs\image-20250317182903302.png)

* 三种总线分类方式

![image-20250315181612865](imgs\image-20250315181612865.png)

* **串行总线** —— 串行发送数据，一次1bit
  * 优：抗干扰能力强，适合远距离传输；只有一根线节省了布线空间；省钱
  * 缺：面临着串并行转换问题(CPU一次处理一组长度为机器字长的数据)
* **并行总线** —— 并行发送数据，一次多bit
  * 优：快，假如总线长度=机器字长，则总线-CPU没有串并行转换问题；总线长度=存储字长，则总线-主存没有串并行转换问题
  * 缺：抗干扰能力弱，远距离传输贵；占用布线空间
* **串行不一定比并行慢**，因为并行抗干扰能力弱，发送信号有频率限制

![image-20250317184241709](imgs\image-20250317184241709.png)

* 片内总线 —— 连CPU内部部件

* 系统总线 —— 连CPU-外设

  * 数据总线 —— 双向；CPU从主存取指令、操作数；长度依赖机器字长(CPU处理方便)、存储字长(从主存取数据方便)

    * 数据通路：逻辑概念，这里的数据是存放在计算机里的数据的泛指
    * 数据总线：物理概念，这里的数据指的是指令、数据

  * 地址总线 —— 单向；CPU传地址给主存、I/O设备；长度依赖主存容量、I/O设备数量

  * 控制总线 —— 每根控制线传输一个控制信号，一根控制线是单向的，但控制总线总体是双向的

    ​			 出：CPU发布控制命令；	进：主存、I/O设备给CPU的反馈信号

* 通信总线 —— 连不同的计算机系统

> 系统总线结构
>
> * 单总线结构 —— 系统总线只有一根
>
>   ![image-20250317184505991](imgs\image-20250317184505991.png)
>
>   * 优：简单，接入方便
>   * 缺：容易发生冲突，慢（CPU和主存、I/O设备直接相连）
>
> * 双总线结构 —— CPU、主存、通道使用 **主存总线** 连接；
>
>   ​			     通道、所有I/O设备使用 **I/O总线** 连接
>
>   ![image-20250317185119250](imgs\image-20250317185119250.png)
>
>   * **通道** —— 统一管理各种I/O设备的数据传送，缓解主存和I/O设备的速度差异
>   * **突发/猝发 —— 传一个地址，返回一串数据**（根据空间局部性原理）
>
> * 三总线结构 —— CPU和主存通过 主存总线 连接
>
>   ​			     CPU和高速外设通过 DMA 连接（磁盘）
>
>   ​			     CPU和低速外设通过 I/O总线 连接（打印机、键盘）
>
>   ![image-20250317190811187](imgs\image-20250317190811187.png)
>
>   * 速度：主存总线 > DMA > I/O总线
>
>   * 优：DMA连接磁盘(高速外设)和内存**
>
>     ​	**I/O总线直接连接CPU和低速外设**
>
>     ​	对不同外设采取更贴合各自存取速度的数据传输方式，提高了I/O设备的性能，提高系统吞吐量
>   
>   * 缺：主存、DMA、I/O总线，在一个时间只能允许一条接通，系统工作效率低

![image-20250317192005291](imgs\image-20250317192005291.png)

* 桥接器 —— 在四总线结构中，缓解各类总线速度差异，以及解决总线仲裁问题
* 越靠近CPU的总线，速度越快

### 总线性能指标

<img src="imgs\image-20250317212417207.png" alt="image-20250317212417207" style="zoom:50%;" />

![image-20250317212836938](imgs\image-20250317212836938.png)

* 总线周期（总线传输周期）
  * $总线传输 = 申请(总线仲裁) + 寻址 + 传输 + 结束，四个阶段$
* 总线时钟周期
  * $通常，总线时钟周期 = CPU时钟周期，但桥接器也可能会提供不同的总线时钟周期$
  * 一个总线周期 可能对应 多个总线时钟周期，可能对应一个总线时钟周期，也可能多个总线周期对应一个总线时钟周期
* 总线工作频率
  * $1/总线周期$
  * 意味着总线一秒可以传多少次数据
* 总线时钟频率
  * $1/总线时钟周期$
  * 意味着总线一秒包含多少总线时钟周期

![image-20250317213749726](imgs\image-20250317213749726.png)

* 总线宽度

  * $通常指的是数据总线有多少bit$

* 总线带宽/总线最高传输速率

  * $总线带宽 = 总线工作频率 * 总线宽度 = \frac{总线宽度}{总线周期}$

  * 意味着总线一秒可以传多少bit数据

  * 总线传输的数据，可能不完全都是有效数据（比如包含校验位）

    $总线有效数据传输率 = 总线带宽 * 有效数据比例$

  * 并行总线不一定比串行总线快，因为虽然总线宽度小，但总线工作频率大

![image-20250317215856483](imgs\image-20250317215856483.png)

* 总线复用
  * 总线分时复用，例如数据总线和地址总线使用同一组总线在不同时间传输数据、地址
  * 时间换空间，因为地址和数据总线复用，就注定了地址和数据不能同时传输
* 信号线数
  * 信号线数 = 所有总线的根数和

#### 性能指标例题

![image-20250317215435586](imgs\image-20250317215435586.png)

## 仲裁(总线争用)

![image-20250318173549727](imgs\image-20250318173549727.png)

* 设备通过**控制总线**，向CPU发布**使用总线的请求**

  请求通过之后该设备可以**使用数据总线、地址总线传输数据**

* 主设备、从设备

### 集中仲裁方式

* **总线控制器** —— 收集所有设备请求，判断把总线使用权交给其中哪一个

  集成在**CPU或桥接器**里（总线时钟周期也是CPU或桥接器决定的）

链式查询方式：

![image-20250318174404417](imgs\image-20250318174404417.png)

* 只有三根线就能实现总线总裁 —— BG、BR、BS

* **BS**总线忙 信号，是**获得总线权限的设备发送的**

* 优：优先级，结构简单，易扩充

  缺：低优先级饥饿，故障敏感

* **控制总线根数 = 3**

计数器查询方式：

![image-20250318175041141](imgs\image-20250318175041141.png)

* BG由原本的一根控制线，变成了一组设备地址

* 总线控制器根据计数器的值，作为设备编号选择设备

  1. 每次当前设备使用完总线，计数器清零（退化成链式查询方式）
  2. 每次计数器值不变，新请求发出则计数器值+1（比较公平）
  3. 其他计数器设计方式

* 优：没有优先级，或自设优先级，不故障敏感

  缺：控制线长度增加，控制逻辑设计复杂

* **控制总线根数 = $\lceil log_2{n}\rceil + 2$**

独立请求方式：

![image-20250318175958199](imgs\image-20250318175958199.png)

* BS线通用，每个设备都连一个BR一个BG

* 优：快(总线控制器和外设直连)

  缺：线多，控制逻辑设计复杂

* **控制总线根数 = 2n + 1**

![image-20250318180315649](imgs\image-20250318180315649.png)

* BS总线忙 信号，都是主设备(获得总线控制权的设备)发出的

### 分布仲裁方式

![image-20250318180558731](imgs\image-20250318180558731.png)

* 去中心化

  想获得总线使用权的外设，就发送仲裁号，同时也会获得其他设备的仲裁号

  如果获得的仲裁号里有比自己高的，就撤销仲裁申请

## 总线传输

### 四个阶段

* 主设备获得总线使用权后，如何和从设备进行数据传输

![image-20250318181537305](imgs\image-20250318181537305.png)

* 申请 —— 请求 + 仲裁，确定**主设备**

  寻址 —— 主设备根据地址(设备编号)，指明**从设备**，并发出**读/写命令**

  传输 —— 主设备和从设备进行**数据传输**

  结束 —— 主设备有关信息从系统总线撤销，**让出总线使用权**

### 四种定时方式

* 总线定时 —— 控制四个传输阶段，它的实质是一种协议或规则
  * 同步通信 —— 根据**总线控制器发送的统一的总线时钟周期**执行总线通信
  * 异步通信 —— 设备使用**应答方式**协商通信，而不是根据时钟
  * 半同步通信 —— 同步 + 异步
  * 分离式通信 —— 充分挖掘总线利用率

#### 同步通信/同步定时方式

![image-20250319174008630](imgs\image-20250319174008630.png)

* 同步通信/同步定时方式 —— 根据**总线控制器**发送的**统一的总线时钟周期**执行总线通信

* 规定**一个总线周期进行一次数据传送**

* 每个总线周期由四个总线时钟周期组成（申请、取指、传输、结束），**总线周期之间没有时间空隙**

* **优**：统一所以逻辑简单；理论上只要缩短总线周期，就能加快总线通信速度

  **缺**：总线通信时间强制固定又没有空隙，所以容错差，可靠性差

* 适用于 **总线长度较短**(传输不太可能出错) 、**总线所接部件存取速度接近**(如果CPU接硬盘，总线周期长则浪费CPU，短则硬盘速度跟不上)的系统

#### 异步通信/异步定时方式

![image-20250319175744213](imgs\image-20250319175744213.png)

* 异步通信/异步定时方式 —— 设备使用**应答方式**，协商通信，而不是根据时钟

* 主设备发出**请求信号** (包括从设备的**地址**、读/写**命令**)

  从设备接收到请求信号，会发送**回答信号** (即**传输数据**)

* 异步定时方式的三种类型：

  * 不互锁 —— 请求撤销不受限、回答撤销不受限
  * 半互锁 —— 请求撤销受限 (接收到回答信号后再撤回)、回答撤销不受限
  * 全互锁 —— 请求撤销不受限 (接收到回答信号后再撤回)、回答撤销不受限 (接收到请求撤销信号后再撤回)

  * **受限信号多**意味着要等待，**速度变慢，但更可靠**

![image-20250319180432967](imgs\image-20250319180432967.png)

* 优：**自动适应时间**，传输更**可靠**

  缺：实现**复杂**，速度**慢**（半互锁，全互锁）

#### 半同步通信

![image-20250319192737092](imgs\image-20250319192737092.png)

* 在同步通信的基础上，增加一个 $\bar{wait}$ 等待信号

  如果通信出现问题，例如从设备来不及在 寻址阶段 准备好 传输阶段 要发送的数据，就置 $\bar{wait}$ 有效，主设备就会等待

* 在**统一时钟**的基础上，给予**自我调节能力**

#### 分离式通信

![image-20250319193230064](imgs\image-20250319193230064.png)

* 请求信号发出 -> 从设备准备好数据 -> 发送回答信号

  其中，从设备准备数据是不占用总线的，但纳入了总线周期

* **把总线通信分为两个子通信**

  主设备发出请求信号后，结束占用总线

  从设备准备好回答信号后，申请占用总线，把回答信号发给主设备（这时其实”从设备“是主设备）

* 采用**同步通信**方式，即每个总线周期长度一致；

  主设备发送了请求信号就放弃总线使用权，**不等回答**

* **提高了总线利用率**

![image-20250319193939394](imgs\image-20250319193939394.png)

## 标准(业界物理标准)

![image-20250322135802326](imgs\image-20250322135802326.png)

* 总线需要满足统一规定的标准

![image-20250322140010976](imgs\image-20250322140010976.png)

* **系统总线** —— 和**CPU**直接相连
* **局部总线** —— 和**北桥**芯片直接相连
* **设备总线/通信总线** —— 和**南桥**芯片直接相连

### 总线发展历程

* 热插拔 —— 在设备通电运行的情况下，允许用户插入或移除硬件设备，而**无需关闭系统或重启**
* 即插即用 —— 设备插入系统后，操作系统能够**自动识别并配置**设备，无需用户手动安装驱动程序或设置硬件参数
* 虽然连接硬盘的总线也属于设备总线，但硬盘是高速I/O设备

总线标准|全称| 细节                                                         |最大速度|特点
:------:|:--:|:-------|:------:|:--:
ISA|Industry Standard Architecture|CPU作为总线控制器|8MB/s|并行系统总线
EISA|Extended ISA|从CPU中分离出了总线控制权，支持多个总线主控器和突发传送|32MB/s|并行系统总线
||||
VESA|Video Electronics Standard Architecture|1. 速度更快，专门处理图像数据 <br>2. CPU作为总线控制器（随着CPU速度提升，总线时钟周期越来越短，VESA逐渐跟不上速度）|132MB/s|并行局部总线
PCI|Peripheral Component Interconnect|1. 也**可以用作系统总线**<br>2. **北桥芯片**作为总线控制器（可以适应CPU时钟周期改变，因为总线时钟周期使用了和CPU时钟周期不同的标准）|133/528MB/s|并行局部总线
AGP|Accelerated Graphics Port|1. 第二代PCI技术<br>2. 适应日益增长的图形处理需求<br>3. 它是一套标准，例如X1和X8是不同的标准|X1:266MB/s X8:2.1GB/s|并行局部总线
PCI-E|PCI-Express (3GI0)|1. 第三代PCI技术<br>2. **点对点串行连接**<br>3. 支持**双向/全双工**传输<br>4. 支持热插拔|10GB/s以上|串行局部总线
                 |                                                         |                                                              |                       |              
     RS-232C     |                  Recommended Standard                   | 很慢，实现计算机和针式打印机的数据传输                       |        20Kbps         | 串行通信总线 
      SCSI       |             Small Computer System Interface             | 实现和打印机、扫描仪等设备的数据传输                         |        640MB/s        | 并行通信总线 
     PCMCIA      | Personal Computer Memory Card International Association | 1. 便携设备接口（古早计算机之间通过存储卡交换数据）2. 即插即用 |        90Mbps         | 并行通信总线 
       USB       |                  Universal Serial Bus                   | 1. 支持**热插拔、即插即用**<br>2. 具有很强的连接能力和很好的可扩充性。采用**菊花链**形式将众多外设连接起来(类似集线器)，可使用USB集线器链式**连接127个外设**<br>3. USB虽然是串行设备总线，但是它使用了**差模信号**（两根线传输1bit的数据，例如A高B低是1，B高A低是0），另外使用了**双绞线结构**。这两个配置方式，使**USB的抗干扰能力特别强**，所以**可以把传输频率提升到很高** |       1280MB/s        | 串行通信总线 
                 |                                                         |                                                              |                       |              
 IDE（ATA)(PATA) |              Integrated Drive Electronics               | 硬盘光驱接口                                                 |        100MB/s        | 并行通信总线 
      SATA       |          Serial Advanced Technology Attachment          | 硬盘光驱接口                                                 |        600MB/s        | 串行通信总线 

![image-20250322150546376](imgs\image-20250322150546376.png)

* **总线带宽 = 总线工作频率 * 总线宽度**

  * 对于**并行总线**，因为有线路干扰，**传输频率提升有上限**，可以通过**增加总线宽度**来提速

  * 对于**串行总线**，总线宽度只有1，可以通过**提高总线传输频率**来提速

    虽然总线宽度低，但串行总线可以把传输频率提升到很高，所以**可能用串行传比并行还快**

* 串行总线有时可能也是多根线：

  * 并行总线是一组数据放在一组总线，在同一时刻传递一组数据
  * 串行总线是**一组数据放在一根线**，在传输期间一个线传递一组数据
