# 数据链路层

## 数据链路层的功能

![image-20250517230935790](imgs\image-20250517230935790.png)

* 从应用层 -> 传输层 -> 网络层 -> 数据链路层 -> 物理层，数据的单位：

  ​	报文 -> 报文段 -> 数据报/分组 -> 帧 -> 比特

* 物理链路 —— 由传输介质和物理层实现

  **逻辑链路 = 数据链路** —— 由**数据链路层**，基于物理链路实现的**逻辑无差错**链路

![image-20250517231836424](imgs\image-20250517231836424.png)

* 数据链路层的功能 —— 
  1. 封装成帧（组帧）
     * 帧定界 —— 从物理层的比特流中区分出帧的边界
     * 透明传输 —— 去除帧首部和尾部，还原成分组交给网络层
  2. 差错控制 —— 比特错误
     * 丢弃
     * 纠正
  3. 可靠传输 —— 帧错误
     * 帧丢失
     * 帧重复
     * 帧失序
  4. 流量控制 —— 发送方考虑接收方的接受能力
  5. 介质访问控制 —— 解决广播式网络中的介质争用问题

### 1. 封装成帧（组帧）

#### 1）字符计数法

![image-20250517234000760](imgs\image-20250517234000760.png)

* 首部指示**帧长**（包含首部和数据的长度）
* 缺：一个计算字段出错会导致后续全部出错

#### 2）字节填充法

![image-20250517234332580](imgs\image-20250517234332580.png)

* SOH —— Start Of Header 开始
* EOT —— End Of Transition 结束
* ESC —— 转义字符，数据部分的SOH、EOT、ESC前都要加ESC

#### 3）零比特填充法

![image-20250517235053721](imgs\image-20250517235053721.png)

* 在首部和尾部都加上 01111110（有连续的6个1）

  发送方 —— 扫描数据，有连续的5个1时立即在后边添加一个0

  接收方 —— 扫描数据，有连续的5个1时立即在后边删除一个0

* 数据链路层有两个重要的实现协议，**HDLC协议、PPP协议**都使用**零比特填充法**作为组帧方法

#### 4）违规编码法

![image-20250517235303514](imgs\image-20250517235303514.png)

* 需要物理层的配合
* 如果物理层采用**曼彻斯特编码**，中间必定跳变，**物理层在帧前后加上一个违规编码（中间没有跳变的编码）**

![image-20250517235554294](imgs\image-20250517235554294.png)

### 2. 差错控制

* 差错控制 —— 为了避免**位错误**

  + 检错编码：
    + 奇偶校验码
    + 循环冗余校验码（$CRC$）

  + 纠错编码：海明校验码

#### 1）奇偶校验码

![image-20250518105541454](imgs\image-20250518105541454.png)

* 双方**提前约定**好是奇校验还是偶校验

​	**奇偶校验码 = 一个校验位 + 多个信息位**，校验位的作用是使数据中有奇数/偶数个1

* 偶校验 —— 

  * 发送方：对所有**信息位异或**，得到的**结果作为校验位**

  * 接收方：对**所有位异或**，得到的**结果是1**说明传输**一定出错**，**是0**说明**可能未出错**（无法发现偶数比特错误）

![image-20250518105740539](imgs\image-20250518105740539.png)

#### 2）循环冗余校验码(CRC码)

![image-20250518110356155](imgs\image-20250518110356155.png)

* 双方**提前约定**好一个**除数**

  **CRC码 = K个信息位 + R个校验位**，校验位的作用是保证数据除以除数后，余数是0

发送方：

![image-20250518111343053](imgs\image-20250518111343053.png)

* **生成多项式**是 $G(x) = x^3 + x^2 + 1$，即约定的**除数**是 1101
* **除数**有4位，**校验码**有 4 - 1 = 3 位
* 生成多项式确定后，**出错位对应的余数**也确定
* 校验码 = 信息码 / 除数 得到的余数，但使用**模2除**和**模2减**
  * 模2除 —— 只要当前余数最高位是1，就上位1
  * 模2减 —— 异或运算

接收方：

![image-20250518111904242](imgs\image-20250518111904242.png)

* 数据 / 除数（使用**模2除**和**模2减**），余数是0证明没有出现比特错误

![image-20250518111134995](imgs\image-20250518111134995.png)

* 除数有 4 位 

  ​	-> 校验位有 3 位 

  ​		-> 校验位可以表示 8-1=7 种错误（000表示无误） < 数据位有 9 位（数据位 = 信息位 + 校验位）

![image-20250518113717018](imgs\image-20250518113717018.png)

* 校验位有 R 位，可以表示 $2^R - 1$ 种错误

  如果 $2^R - 1 ≥ K + R$，**CRC也可以**有一位**纠错**能力

  由于校验位过长，CRC通常**只用来检错**

![image-20250518113955207](imgs\image-20250518113955207.png)

#### 3）海明校验码(汉明校验码)

* **海明码**是**偶校验**的延申，具有**纠错**能力

![image-20250518115341992](imgs\image-20250518115341992.png)

* 校验位数 k，需要满足 $2^k ≥ n + k + 1$

* 校验位 $P_i$ 必须放在海明位号为 $2^{i-1}$ 的位置上

* $P_i$ 掌管 位号的二进制码中第$i$位是1的海明位

  例如，$D_1$放在$H_3$位置，对应二进制$001$，因此它属于$P_1$ 组

  ​	   $D_2$放在$H_5$位置，对应二进制$101$，因此它属于$P_1$ 组和 $P_3$组

* 发送方 —— $P_i$的值，就是$P_i$组所有位的异或结果

![image-20250518120141048](imgs\image-20250518120141048.png)

* 接收方 —— **把$P_i$和它所在组所有位**进行异或运算

  结果是$S_3S_2S_1$是000证明无误，结果是001证明$H_1$有误，......，111证明$H_7$有误

![image-20250518120634260](imgs\image-20250518120634260.png)

* 如果$H_3$出错会出现011，如果$H_1、H_2$出错也会出现011，无法判断是1位出错还是2位出错

  加上**全校验位**，海明码可以进行**一位纠错，两位检错**

![image-20250518120906896](imgs\image-20250518120906896.png)

### 3. 可靠传输、4. 流量控制

* 差错控制如果只检错，然后丢弃帧，就会引发帧丢失问题，需要可靠传输技术解决问题

![image-20250518151311392](imgs\image-20250518151311392.png)

* 三种协议实现流量控制和可靠传输

  都利用了**滑动窗口机制**

![image-20250518151630685](imgs\image-20250518151630685.png)

* 发送窗口 $W_T$，表示目前允许发送方发送的帧

  接收窗口 $W_R$，表示目前允许接收方接收的帧

* **接受方**通过**确认机制**，**控制**发送方的**发送窗口**向前滑动，从而实现**流量控制**

* **用n bit给帧编号 —— 必须满足 $W_T + W_R ≤ 2^n$，**即 帧编号所占位数，必须覆盖发送窗口+接收窗口的总长度


#### 1）停止等待协议 (S-W)

![image-20250518211731052](imgs\image-20250518211731052.png)

* 停止等待协议 = S-W协议 —— $W_T = 1, W_R = 1$
* 帧序号占1比特

![image-20250518213014238](imgs\image-20250518213014238.png)

* 帧的首部尾部是**控制信息，包含帧类型**（数据帧or确认帧）和**帧序号**

  * 数据帧 —— $Data_i$

    确认帧 —— $ACK_i$

  * 帧类型 —— 为了实现全双工通信

    帧序号 —— 指明确认收到了哪个帧

##### 帧丢失

![image-20250518213224682](imgs\image-20250518213224682.png)

* 帧丢失（数据帧丢失） —— 发送方超时重传

![image-20250518213610525](imgs\image-20250518213610525.png)

* 帧出错（比特错误） —— 接收方丢弃帧，当作帧丢失处理

##### 帧重复

![image-20250518213354413](imgs\image-20250518213354413.png)

* 帧重复（确认帧丢失） —— 发送方超时重传，接收方删除重复帧并重新发送确认帧

* **帧序号**的作用 —— 让**接收方判别重复帧**

![image-20250518213909651](imgs\image-20250518213909651.png)

* S-W协议，没有帧失序问题

#### 2）后退N帧协议(GBN)

![image-20250518214823715](imgs\image-20250518214823715.png)

* 后退N帧协议 = GBN协议 —— $W_T > 1, W_R = 1$

  ​						帧序号所占比特要满足 $W_T + W_R ≤ 2^n$

* 接收方可以累积确认

##### 帧丢失

![image-20250518215039798](imgs\image-20250518215039798.png)

* 帧丢失 —— 接收方丢弃接收窗口以外的帧，重新发送确认帧

  例如0号帧丢失，接收窗口没有前移，这时到达了1号帧，接收方就会丢弃1号帧，重新发送一遍 $ACK_3$

![image-20250518215433341](imgs\image-20250518215433341.png)

* 接收方只返回**连续正确的最后一个数据帧的确认帧**
* 由于接收方是按序接收，发送方只要一个帧超时，后续都会重传
* 后退N帧是发送的帧后退，**发送窗口是一直前进的**

##### 帧重复

![image-20250518215731284](imgs\image-20250518215731284.png)

* 帧重复（确认帧丢失） —— 接收方丢弃重复帧，重新发送确认帧

![image-20250518215931512](imgs\image-20250518215931512.png)

* 必须满足 $W_T + W_R ≤ 2^n$

![image-20250518220215980](imgs\image-20250518220215980.png)

#### 3）选择重传协议(SR)

![image-20250518221159778](imgs\image-20250518221159778.png)

* **选择重传协议 = SR协议** —— $W_T > 1, W_R > 1，W_T ≥ W_R$（否则接收窗口多余位利用率不高）

  ​						帧序号所占比特要满足 $W_T + W_R ≤ 2^n$

* 接收方必须**逐帧确认**

* 接收方可以**请求重传**（发送否认帧$NAK_i$）

##### 帧丢失

![image-20250518225451782](imgs\image-20250518225451782.png)

![image-20250518225520560](imgs\image-20250518225520560.png)

![image-20250518225552755](imgs\image-20250518225552755.png)

* 帧丢失 —— 用超时重传机制重传

##### 帧出错

![image-20250518225709608](imgs\image-20250518225709608.png)

![image-20250518225758437](imgs\image-20250518225758437.png)

![image-20250518225904913](imgs\image-20250518225904913.png)

* 帧出错 —— 用请求重传机制重传（接收方发送否认帧$NAK_i$）

##### 帧重复

![image-20250518230101917](imgs\image-20250518230101917.png)

![image-20250518230136073](imgs\image-20250518230136073.png)

![image-20250518230241624](imgs\image-20250518230241624.png)

![image-20250518230431993](imgs\image-20250518230431993.png)

#### 三种协议的信道利用率分析

##### S-W协议

![image-20250518231717744](imgs\image-20250518231717744.png)

![image-20250518232005655](imgs\image-20250518232005655.png)

##### GBN、SR协议

![image-20250518232313647](imgs\image-20250518232313647.png)

![image-20250518232524120](imgs\image-20250518232524120.png)

* 信道利用率 ≤ 1

  * 如果计算结果 > 1，说明 $T_D + RTT < NT_D$

    即第一条确认帧在发送完一组数据帧之前到达了发送方

    说明信道一直在传输数据帧，信道利用率是1

![image-20250518233106862](imgs\image-20250518233106862.png)

##### 滑动窗口协议、ARQ协议

![image-20250518233759030](imgs\image-20250518233759030.png)

* 提到滑动窗口协议，默认是GBN、SR协议

![image-20250518233937527](imgs\image-20250518233937527.png)

* **ARQ协议** = 超时重传协议，**S-W、GBN、SR**都使用了ARQ协议
* **连续ARQ协议** = 连续超时重传协议，**GBN、SR**才可能发生多个帧连续超时重传

![image-20250518235105254](imgs\image-20250518235105254.png)

![image-20250518235252935](imgs\image-20250518235252935.png)

### 5. 介质访问控制

#### 1）信道划分

![image-20250519115836585](imgs\image-20250519115836585.png)

* 无线通信也可能面临信号冲突问题

##### （1）时分复用 TDM

![image-20250519120204708](imgs\image-20250519120204708.png)

* TDM帧、时隙
* 缺：带宽等分

###### 统计时分复用 STDM

![image-20250519120341840](imgs\image-20250519120341840.png)

* 在TDM的基础上增加了动态按序分配时隙，减少了带宽浪费

##### （2）频分复用 FDM

![image-20250519231445525](imgs\image-20250519231445525.png)

* **总频带** = 多个**子频带** + 多个**隔离频带**

  总频带的范围 = **总带宽**，单位是**Hz**

* 由于频带被切分，**每对**通信双方的通信也**无法达到**信道的**最高传输速率**（频道变小 -> 码元种类变少）

* FDM 只能用于**模拟信号**传输

##### （3）波分复用 WDM

![image-20250519231706521](imgs\image-20250519231706521.png)

* FDM是划电磁波的频率，WDM是划光的波长

##### （4）码分复用 CDM

* CDM 是 **CDMA** 技术的底层原理

![image-20250520164242206](imgs\image-20250520164242206.png)

* 给**每个通信结点**分配 “**码片序列**”

  例如A的码片序列是 (1, 1, 1, 1)，A 要发送数据“101”，则A发送的信号就是 “(1, 1, 1, 1)(-1, -1, -1, -1)(1, 1, 1, 1)”

  ​	B的码片序列是 (1, -1, 1, -1)，B 要发送数据“101”，则B发送的信号就是 “(1, -1, 1, -1)(-1, 1, -1, 1)(1, -1, 1, -1)”

* 通信各方的**码片序列**是**公开**的

![image-20250520165249906](imgs\image-20250520165249906.png)

* 通信各方的**码片序列**要求**必须两两正交**

* 即使 A、B 同时给C发消息时**信号叠加**，C也能通过**规格化内积**得出A、B各自发送的数据

  * **信号叠加** —— A发送1(1, 1, 1, 1)，B发送0(-1, 1, -1, 1)，C接收到的就是(0, 2, 0, 2)

  * **规格化内积** —— 叠加信号 * 发送方的码片序列 / 码片维度

    例如，当前C接收到叠加信号(0, 2, 0, 2)，则C可知A发送的数据是 (0, 2, 0, 2) * (1, 1, 1, 1) / 4 = 1，A发送了1

    ​										   B 发送的数据是 (0, 2, 0, 2) * (1, -1, 1, -1) / 4 = -1，B发送了0

![image-20250520165935119](imgs\image-20250520165935119.png)

![image-20250520170114135](imgs\image-20250520170114135.png)

#### 2）随机访问

![image-20250520170515309](imgs\image-20250520170515309.png)

##### （1）ALOHA协议

###### 纯ALOHA协议

![image-20250520171056388](imgs\image-20250520171056388.png)

* 发送方准备好数据帧，立刻发送

  成功 —— 没有数据冲突，发送成功并收到了确认帧

  失败 —— 有数据冲突，没收到确认帧，**随机等待**一段时间后重新发送

* 发送失败会**随机**等待一段时间重传（如果固定，原本冲突的帧还会冲突）

###### 时隙ALOHA协议

![image-20250520171522152](imgs\image-20250520171522152.png)

* 发送方只允许在**时隙开始时发送协议**

  每个时隙足够长，确保最大长度的数s帧也能在一个时隙内传输成功

##### （2）CSMA协议

![image-20250520171731007](imgs\image-20250520171731007.png)

* 相比ALOHA协议，**CSMA协议**要求发送方**发送前监听信道是否空闲**

  CSMA —— 载波监听

###### 1-坚持CSMA

![image-20250520171931696](imgs\image-20250520171931696.png)

* 发送方监听到繁忙后，**坚持监听到空闲**

  然后**立即发送**数据

  如果发送失败，随机等待一段时间后重传

* 信道利用率高（一旦检测到空闲立即就会有发送方发送数据），但容易发生数据冲突

###### 非坚持CSMA

![image-20250520172459551](imgs\image-20250520172459551.png)

* 发送方监听到繁忙后，放弃监听，**随机等待一段时间后重新监听**

  如果空闲，立即发送数据

  如果发送失败，随机等待一段时间后重传

* 发生数据冲突的可能性下降，但信道利用率降低

###### p-坚持CSMA

![image-20250520172934548](imgs\image-20250520172934548.png)

* 发送方监听到繁忙后，**坚持监听到空闲**

  然后有**p**的概率**立即发送**数据，有**1-p**的概率进入**冷却**，冷却结束后重新监听空闲

  如果发送失败，随机等待一段时间后重传

| 信道状态 |    1-坚持    |                非坚持                |                   p-坚持                   |
| :------: | :----------: | :----------------------------------: | :----------------------------------------: |
|   空闲   | 立即发送数据 |             立即发送数据             | 以概率p发送数据，以概率1-p推迟到下一个时隙 |
|    忙    | 继续坚持侦听 | 放弃侦听，等待一个随机的时间后再侦听 |           持续侦听，直至信道空闲           |

![image-20250520173426233](imgs\image-20250520173426233.png)

##### （3）CSMA/CD协议

* 用于是 **逻辑上总线型结构** 的网络（会发生总线冲突）

![image-20250520174625985](imgs\image-20250520174625985.png)

* CSMA/CD协议 —— CSMA(载波监听) + CD(冲突检测)
  * 基于1-坚持CSMA协议
  * 区别 —— 边发送边监听，冲突则停发，等待r个争用期后重传

![image-20250520175009264](imgs\image-20250520175009264.png)

* 发送方监听到繁忙后，**坚持监听到空闲**

  然后**立即发送**数据

  **发送期间**一直**监听**信道冲突（信号虽然发送，传输需要时间，也许其它结点会在这期间发送消息）

  产生冲突后立即停发，**等待r个争用期**后重传

* **r 的计算**（假设当前是第 k 次发生冲突 )
  * $k ∈ [1-10]$ —— 随机数 $r  ∈ [0, 2^k-1]$ 
  * $k ∈ [10-15]$ —— 随机数 $r  ∈ [0, 2^{10}-1]$ 
  * $k = 16$ —— 停止重传，上报网络层

###### 争用期 r

![image-20250520180609439](imgs\image-20250520180609439.png)

* 争用期 —— 2 * 最大单向传播时延

![image-20250520181158045](imgs\image-20250520181158045.png)

* 若争用期内未发生冲突，就不可能再发生冲突
* **CSMA/CD协议没有ACK机制**，如果争用期没有检测到冲突，就认为帧发送成功

###### 最短帧长

![image-20250520181527887](imgs\image-20250520181527887.png)

![image-20250520181923831](imgs\image-20250520181923831.png)

* 最短帧长 = 争用期 * 信道带宽

* 作用 —— 1. 发送方在**发送数据帧结束前**，能确定有没有发生冲突

  ​		2. 规定冲突停发，因此接收方假如**收到小于最短帧长的帧**，可以确认是非法帧而**丢弃**

![image-20250520191520797](imgs\image-20250520191520797.png)

* **最长帧长** —— 防止某些结点一直发送数据独占信道
* **以太网**使用的介质访问控制协议就是CSMA/CD协议，最短帧长是**64B**，最长帧长是**1518B**

##### （4）CSMA/CA协议

![image-20250523105342827](imgs\image-20250523105342827.png)

* **CSMA/CD**协议 —— 用于早期的**有线以太网（总线型）**

  CD —— 冲突检测

* **CSMA/CA**协议 —— 用于 IEEE 802.11 **无线局域网（WIFI）**

  CA —— 冲突避免

###### 接入点 AP 

![image-20250523105556152](imgs\image-20250523105556152.png)

* AP 是**交换机和无线设备**之间通信的中转站

![image-20250523105813541](imgs\image-20250523105813541.png)

* 漫游 ——物理位置转换时，设备连接的AP也自动切换

![image-20250523110230881](imgs\image-20250523110230881.png)

* 移动站点 —— A B C D等设备
* 固定站点 —— AP
* CD检测冲突，不适合无线局域网

###### 简易CSMA/CA

![image-20250523110803799](imgs\image-20250523110803799.png)

![image-20250523110726139](imgs\image-20250523110726139.png)

* 发送方 —— 检测到空闲 -> **等待DIFS** -> 发送数据帧

  接收方 —— 接收数据帧 -> **等待SIFS**  -> 发送ACK

* 发送方 —— 检测到忙 -> 生成一个等待倒计时(只有**信道闲**时**倒计时走字**) -> 倒计时归零发送数据帧 

  ​			[-> (假如冲突则**收不到ACK**)生成一个等待倒计时(只有信道闲时倒计时走字) -> 倒计时归零发送数据帧 ]

  接收方 —— 接收数据帧 -> **等待SIFS**  -> 发送ACK

###### +信道预约机制

![image-20250523112001193](imgs\image-20250523112001193.png)

![image-20250523111620768](imgs\image-20250523111620768.png)

* **RTS** —— 预约，包括源地址、目的地址、持续时间
* **CTS** —— 允许预约，包括源地址、目的地址、持续时间
  * 接收到CTS后，**发送方等待SIFS**，发送数据帧
* 无线信道是广播式发送，所有接入设备都能接收到CTS，然后其它设备自动**禁言直到预约时间结束**
* 是否启用信道预约机制 —— 由数据帧长度决定，大于指定阈值的数据帧启用信道预约（大的数据帧重传代价高）

![image-20250523114202121](imgs\image-20250523114202121.png)

![image-20250523114512560](imgs\image-20250523114512560.png)

![image-20250523114333593](imgs\image-20250523114333593.png)

#### 3）轮询访问

###### 令牌传递协议

![image-20250523115046420](imgs\image-20250523115046420.png)

* **发送数据**的前提，是当前**令牌号指向本机**

* 过程：

  * 获得令牌的主机**发送数据帧**

  * 数据帧会随着令牌环网的**固定流向**流动

  * 到底非目的主机，不处理

    到达目的主机，如果检测数据帧无差错（例如CRC检验），把已接受的值改为true

  * 回到发送主机，检测到发送成功

  * 把令牌号修改指向下一个主机（每次**获得令牌只能发送一个帧**）

![image-20250523115626022](imgs\image-20250523115626022.png)

* MAU —— 构建令牌环网

![image-20250523115919373](imgs\image-20250523115919373.png)

* 相比于 CSMA/CD 协议，令牌传递协议 更适用于负载高的网络

## 局域网  &  IEEE 802

![image-20250523140338278](imgs\image-20250523140338278.png)

* IEEE组织
  * IEEE 802 委员会 —— 管理物理层、数据链路层的内容
    * 802.3 工作组 <-> 以太网
    * 802.11 工作组 <-> WIFI
      * 802.11 ax 第6代WIFI

![image-20250523165655797](imgs\image-20250523165655797.png)

* **IEEE 802** 主要的工作层次是 **物理层 + 数据链路层**

* **数据链路层 = MAC子层 + LLC子层**

  * 大多数功能是MAC实现

  * LLC的是不同类型的局域网之间的兼容接口

    由于 有线技术被以太网垄断，无线技术被WIFI垄断，LLC几乎不再需要

### 局域网 IEEE 802

![image-20250524112605240](imgs\image-20250524112605240.png)

* 图中主要介绍了局域网的特点、分类、硬件架构

#### 特点

![image-20250524112858598](imgs\image-20250524112858598.png)

* 局域网：
  * 传输范围小
  * 时延和误码率低
  * 各节点间数据**以帧为单位**进行传输
  * 支持**单播、多播、广播**

#### 分类

![image-20250524114045661](imgs\image-20250524114045661.png)

* 关注点：
  * 拓扑结构（点对点/总线型/令牌环网/星型/网状）
  * 传输介质（同轴电缆/双绞线/光纤/无线）
  * 介质访问控制（CSMA/CD、CSMA/CA、令牌传递协议、NULL）
* 有线局域网
  * 以太网
    * **同轴电缆以太网**
    * **双绞线以太网**
      * **用集线器连接**
      * **用交换机连接**
    * **光纤以太网**
  * **令牌环网**
* 无线局域网（WLAN）
  * **WIFI**

#### 硬件架构

![image-20250524122007318](imgs\image-20250524122007318.png)

* 一个电脑可以同时连接**有线网络**和**无线网络**

  它们需要用到**不同的网络适配器**

* **网络适配器 = 网络接口卡 = 网卡** = RAM + ROM

  * RAM —— 帧缓冲

  * **ROM** —— 指明网络适配器的 **MAC地址 = 物理地址 = 硬件地址**，48bit

    ​			每个网络适配器的MAC地址是全球**唯一**的，因为写进ROM里而无法修改

### 1）以太网 IEEE 802.3

![image-20250524123046971](imgs\image-20250524123046971.png)

* 802.3 涉及到 **物理层 + MAC子层**，不考虑 LLC子层

#### （1）物理层标准

![image-20250524133030599](imgs\image-20250524133030599.png)

* 10Base5 —— 10Mbps，同轴电缆，最大段长500m

  10Base-**T** —— 双绞线

  10Base-**F** —— 光纤

* 高速以太网 —— 速率 > **100Mbps**

* 同轴电缆 —— 只能半双工

  双绞线 —— **<2.5Gbps**，根据双方节点的状态确定半双工or全双工

  ​		     >2.5Gbps，只能全双工

  光纤 —— 只能全双工

![image-20250524151549768](imgs\image-20250524151549768.png)

* 不同的网段可以使用不同的标准
* 同轴电缆只支持半双工

![image-20250524151950507](imgs\image-20250524151950507.png)

* 双绞线可能是半双工，也可能是全双工，取决于是否连接了集线器

* 如果是半双工，就要用到CSMA/CD协议

  如果是全双工，可以不使用介质访问控制协议（不需要解决冲突）

#### （2）MAC子层标准

![image-20250524154214603](imgs\image-20250524154214603.png)

* MAC子层有两个标准

  * DIX Ethernet V2标准（更常用）
  * IEEE 802.3标准

  两者有略微区别

* **V2标准**要求在MAC帧声明**IP层使用的协议类型**（IPv4 or IPv6）

  **802.3标准**要求在MAC帧声明**帧的数据长度**（802.3考虑了LLC层，声明IP层协议类型是LLC层的服务）

![image-20250524164553804](imgs\image-20250524164553804.png)

* 目的地址**全1代表广播**

* **V2标准 —— 662N4，收发协数验**

  * CSMA/CD协议对最短帧长、最长帧长有限制（**以太网的标准是帧长 64-1518 bit**），所以 N 的范围是 46-1500 bit

  802.3标准 —— 662N4，收发长数验

* 以太网标准 ——

  * 物理层 —— **曼彻斯特编码**

  * 数据链路层 —— 

    * 差错检验 —— **CRC** 

    * 介质访问控制 —— **CSMA/CD协议**

* IP层数据报 -> MAC层帧 —— 前缀：目的MAC地址、发送MAC地址、IP协议类型

  ​                                                  后缀：循环冗余校验码CRC

  MAC层帧 -> 物理层比特 —— 前缀：前导码=前同步码+帧开始定界符（帧结尾定界：违规编码+发送间隙）

* FCS —— 位于帧尾的 **帧校验序列**，用于整个帧的差错控制

![image-20250524165939754](imgs\image-20250524165939754.png)

* **交换机、路由器 都有多个MAC地址**（每个接口对应一个MAC地址）

  集线器没有（集线器只工作到物理层，没有到数据链路层）

* **交换机支持单播，集线器只支持广播**

  路由器不会处理广播消息

![image-20250524170359356](imgs\image-20250524170359356.png)

* 交换机隔离冲突域

  路由器隔离广播域

![image-20250524170625020](imgs\image-20250524170625020.png)

### 2）虚拟局域网(VLAN) IEEE 802.1Q

![image-20250524181130939](imgs\image-20250524181130939.png)

* VLAN —— 解决大型局域网带来的问题
  1. 广播风暴
  2. 数据安全

![image-20250524181641769](imgs\image-20250524181641769.png)

* VLAN —— 把大型局域网划分成多个虚拟局域网

  1. **广播**只会在虚拟局域网内部传播
  2. 跨虚拟局域网的**访问**是受限制的

  每个VLAN对应一个**VID**，例如VLAN-**10**、VLAN-**20**

* 普通交换机不支持VLAN

  **支持VLAN功能的以太网交换机**才能实现虚拟局域网的分配

* 主机 <-> 交换机，用普通链路连接

  交换机 <-> 交换机，用**干线链路**连接

#### （1）基于接口划分VLAN

![image-20250524181934127](imgs\image-20250524181934127.png)

* **VID 与 接口** 的映射关系存储在**交换机内部**

* 这样VLAN认接口不认节点

  如果节点连接的接口改变，节点对应的VLAN也可能改变

* 所有**跨交换机的VLAN**，都必须包含**连接干线链路的接口**

  * 例如，ABCDHI 同属于VLAN-10，则：

    在交换机1，VLAN-10有1，2，3，4，**8**

    在交换机2，VLAN-10有**1**，2，3

  * 1-1连接的设备广播：（指交换1的1号接口）

    广播信息会发往1-2，1-3，1-4，1-8接口

    数据从1-8接口传递到2-1接口

    交换机2发现是VLNA-10的数据，继而发送给2-2，2-3接口

![image-20250524185234474](imgs\image-20250524185234474.png)

* 交换机2是怎么判别发送到2-1的帧是VLAN-10的，还是VLAN-20的：
  * 主机 <-> 交换机 —— 标准以太网帧（662N4，收发协数验）
  * 交换机 <-> 交换机 —— 802.1Q帧，（6642N4，收发V协数验，增加的4指明了VID）

![image-20250524185758949](imgs\image-20250524185758949.png)

* 802.1Q帧，6642N4

* 中间增加的 **4B = 2B + 4bit + 12bit**，

  ​			  = 指明帧类型是802.1Q帧 + 无用位 + VID

* 把 标准以太网帧转换成802.1Q帧，帧末尾的**CRC**也要**刷新**

#### （2）基于MAC地址划分VLAN

![image-20250524182343859](imgs\image-20250524182343859.png)

* **VID 与 MAC地址** 的映射关系存储在**交换机内部**
* 交换机可以根据MAC地址，向对应的接口发送帧

#### （3）基于IP地址

![image-20250524182611701](imgs\image-20250524182611701.png)

* **VID 与 IP地址** 的映射关系存储在**交换机内部**
* 基于IP地址划分VLAN ——
  * 可以**跨路由器**划分VLAN
  * 交换机需要实现 物理层、数据链路层、网络层 的功能

![image-20250524190234835](imgs\image-20250524190234835.png)

### 3）无线局域网 IEEE 802.11

![image-20250524190506142](imgs\image-20250524190506142.png)

* 无线局域网
  * 有固定基础设施 —— 802.11(WIFI)
  * 无固定基础设施 —— 自组织的局域网，如苹果隔空投送

![image-20250524214342966](imgs\image-20250524214342966.png)

* **家用路由器 = 路由器 + 交换机 + AP**

* 由**交换机**组成的**有线网络**，使用以太网**802.3**协议

  由**AP**组成的**无线网络**，使用WIFI**802.11**协议

* 有线网络和无线网络是两个局域网，它们通过**门户Portal**连接称为一个更大的局域网

  Portal —— 实现协议的相互转换

![image-20250524215729970](imgs\image-20250524215729970.png)

* AP = WAP = 接入点 = 无线接入点
* 802.11 无线局域网是星型拓扑，使用CSMA/CA协议
* **BSS** = 1个基站(WIFI热点) + 多个移动站(移动设备)
  * SSID —— 无线局域网的名字，< 32B
  * BSA —— 无线局域网的地理覆盖范围
* 多个BSS可以组成**扩展服务集ESS**

![image-20250524220003735](imgs\image-20250524220003735.png)

* 扩展服务集 ESS 带来漫游效果（丝滑的WIFI热点切换）

#### 802.11数据帧的组成

![image-20250524220209737](imgs\image-20250524220209737.png)

* 802.11协议规定了三种帧
  * 数据帧
  * 控制帧 —— RTS、CTS、ACK
  * 管理帧 —— 发出、响应 WIFI请求

![image-20250524221203087](imgs\image-20250524221203087.png)

* 记忆口诀：

  * 30(首部) + N(数据，0-2312) + 4(FCS验证)

  * 帧控制字段有2B，其中第9、10bit表示去往AP、来自AP（移动数据之间的数据传输必须经过AP中转）

  * 对于9、10bit是10（去往AP）的帧，地址1、2、3分别表示中转、起始、终止地址

    对于9、10bit是01（来自AP）的帧，地址1、2、3分别表示终止、中转、起始地址

    所以AP中转数据时，需要修改9、10bit以及地址1、2、3

![image-20250524221837955](imgs\image-20250524221837955.png)

* **AP** 可能与其他设备进行 —— **有线**（其它AP、路由器、交换机）/ **无线**（移动设备） —— 的连接

  所以它也需要实现**帧格式转换**（802.11 <-> 802.3）

![image-20250524223154885](imgs\image-20250524223154885.png)

* 持续期 —— 本帧结束后，还需要占用多少时间（RTS的持续期比CTS长）

![image-20250524222518712](imgs\image-20250524222518712.png)

## 广域网

![image-20250524224424509](imgs\image-20250524224424509.png)

* 广域网**WAN**和局域网**LAN**，两者根据覆盖范围和用途划分，它们是**平等**地位，不是包含关系

* **广域网 = 节点交换机 + 链路** [+ 主机]

  节点交换机 —— 在**单个网络**中转发分组（例如只在广域网中）

  路由器 —— 在**多个网络**中转发分组（例如连接广域网和局域网）

* 互联网 = 广域网 + 局域网 + 路由器

  局域网与另一个较远的局域网之间可以通过广域网进行通信

* 广域网使用**分组交换**技术通信

|                 |              广域网              |          局域网          |
| :-------------: | :------------------------------: | :----------------------: |
|    覆盖范围     |         很广，通常跨区域         |  较小，通常在一个区域内  |
|    连接方式     |       通常是**点到点**连接       |     普遍采用广播信道     |
| OSI参考模型层次 | 三层：物理层，数据链路层，网络层 | 两层：物理层，数据链路层 |
|     着重点      |           **资源共享**           |         数据传输         |

* 广域网里，各**节点交换机之间是点对点连接**

* 广域网的主要目的是资源共享（传输速度）

  局域网的主要目的是数据传输（传输质量）

### PPP协议

#### 使用场景

![image-20250525114549934](imgs\image-20250525114549934.png)

* 点对点协议（Point-to-Point Protocol, PPP）

  * 用户接入ISP
  * 两台设备直连

  **PPP是数据链路层协议**

#### LAP + NCP + 封装成帧

![image-20250525114659498](imgs\image-20250525114659498.png)

* PPP = LCP + NCP + 封装成帧

#### PPP帧

![image-20250525114053690](imgs\image-20250525114053690.png)

* **PPP帧 —— 1112N21，界AC协数验界**
* 信息部分 0-1500B （点对点的数据传输不需要考虑介质访问控制，不使用CSMA/CD协议，所以没有最短帧长限制）

#### 透明传输

![image-20250525114319139](imgs\image-20250525114319139.png)

##### 面向字节的异步链路(字节填充

![image-20250525114934582](imgs\image-20250525114934582.png)

##### 面向比特的同步链路(零比特

![image-20250525115302760](imgs\image-20250525115302760.png)

#### PPP协议流程

![image-20250525110624235](imgs\image-20250525110624235.png)

* PPP通信前的三个关卡：

  1. **建立LCP链路（LCP协商）**：

     - 通信双方通过LCP协议协商链路参数（如认证方式、最大传输单元MTU）
     - 若协商失败，链路静止

  2. **鉴别阶段（可选）**：

     - 根据LCP协商的认证方式（如PAP、CHAP）验证对方身份
     - 若鉴别失败，链路终止

     链路终止时，LCP链路还在，链路静止时，LCP链路已被销毁

  3. **网络层协议配置阶段（NCP协商）**：

     - 为每个网络层协议（如IP、IPv6）单独配置参数

       例如：通过IPCP为客户端**分配临时IP地址**

     - 若某个网络层协议协商失败，不影响其他协议（如IP失败但IPX仍可用）

* PPP协议的特点：

  * PPP是**不可靠服务**

    只用了CRC实现差错控制，没有帧序号，没有确认机制

  * PPP只支持**全双工**的**点对点**链路

  * PPP的**两端**可以使用**不同的网络层协议**

    NCP的作用就是协商不同网络层协议

  * PPP是面向字节的，即PPP帧的**长度必须是整数个字节**

## 数据链路层设备

### 以太网交换机

#### 自学习功能

![image-20250526112104029](imgs\image-20250526112104029.png)

* 每台交换机至少维护一个交换表

  交换表初始为空

* **以太网帧 662N4，收发协数验**

  前12B存储了**目的MAC地址**和**发送方MAC地址**

* 交换机初次受到以太网帧

  * 可以**确定发送MAC地址和对应的端口号**，写入交换表
  * 由于**不知道接收方MAC地址**，交换机以**广播**的形式转发以太网帧

* 如果发送方地址和目的地址**相同**，交换机**不会再转发**数据（K->J）

![image-20250526112352229](imgs\image-20250526112352229.png)

* 为了迎合不断发生的变化，交换表的每一个表项都有有效期

  **过期自动作废**

* 由于交换机设置了有效期，所以支持**即插即用**

#### 直通 VS 存储转发交换

![image-20250526112815516](imgs\image-20250526112815516.png)

* **直通交换** —— 交换机收到帧后，**只检查目的地址**，然后转发

  ​			 快，但不支持速率匹配、协议转换、差错控制

* **存储转发交换** —— 交换机收到帧后，**检查整个帧**，然后转发

  ​			 优缺点和直通交换正好相反

  * 速率匹配 —— 支持收发速率不同的节点互相通信
  * 协议转换 —— 支持转变协议类型然后再转发帧（标准帧 <-> 802.1Q帧）

![image-20250526113327949](imgs\image-20250526113327949.png)

![image-20250526113406307](imgs\image-20250526113406307.png)



























