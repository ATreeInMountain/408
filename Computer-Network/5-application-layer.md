# 应用层

任务：

![image-20250606180641129](imgs\image-20250606180641129.png)

* 解决特定应用任务

常见应用：

![image-20250606180901039](imgs\image-20250606180901039.png)

## C/S模式、P2P模式

![image-20250613195241611](imgs\image-20250613195241611.png)

* 服务器总是处于运行状态，有固定端口号
* 虚拟服务器 —— 实现负载均衡

![image-20250613195813926](imgs\image-20250613195813926.png)

* 系统性能不会因为规模增大而降低（每个主机既是服务请求方，也是服务提供方）

## 1）动态主机配置协议 DHCP

* DHCP —— CS模式，给主机配置动态IP地址

![image-20250602230313538](imgs/image-20250602230313538.png)

* DHCP —— 为刚接入网络的主机分配 **IP地址**、**子网掩码**、**默认网关**、**DNS服务器**

![image-20250602230355783](imgs/image-20250602230355783.png)

* DHCP使用的传输层协议是**UDP协议**
* DHCP协议的**服务方端口是 67**，**客户方端口是 68**

![image-20250602230921546](imgs/image-20250602230921546.png)

* DHCP服务器 —— 负责管理整个子网的**IP地址分配**

1. DISCOVER

   ![image-20250602231534192](imgs/image-20250602231534192.png)

   ![image-20250602231924661](imgs/image-20250602231924661.png)

   * 发送方IP：0.0.0.0	发送方MAC：自己的MAC地址

     接收方IP：广播	    接收方MAC：广播

     发送端口：68	       接受端口：67

   * DHCP协议的 **服务方端口是 67**，**客户方端口是 68**

     由于特殊应用占用的端口号是**固定**的，计算机上不允许其它进程用到67号端口

     所以只有**DHCP**服务器能成功接收

2. OFFER

   ![image-20250602232550922](imgs/image-20250602232550922.png)

   * 发送方IP：DHCP服务器的IP	发送方MAC：DHCP服务器的MAC地址

     接收方IP：广播	    		 接收方MAC：DHCP客户的MAC地址

     发送端口：67	      		  接受端口：68

   * DHCP分配的IP地址是有**租用期**的

     租用期快到时，DHCP客户需要重新发送DHCP报文续租

3. REQUEST

   ![image-20250602233329118](imgs/image-20250602233329118.png)

   * 发送方IP：0.0.0.0	发送方MAC：自己的MAC地址

     接收方IP：广播	    接收方MAC：广播

     发送端口：68	      接受端口：67

   * 目前主机仍然认为自己的IP地址是0.0.0.0 —— 在ACKNOWLEDGE后，主机才能确认被分配到的IP地址

   * 为什么依然广播MAC、广播IP —— 一个子网可能有不止一个DHCP服务器，需要让所有DHCP服务器都统一确认

4. ACKNOWLEDGE

   ![image-20250602233506232](imgs/image-20250602233506232.png)

   * 发送方IP：DHCP服务器的IP	发送方MAC：DHCP服务器的MAC地址

     接收方IP：广播	    		 接收方MAC：DHCP客户的MAC地址

     发送端口：67	      		  接受端口：68

   * 和OFFER报文内容几乎一致，只是为了最后确认

![image-20250602233646666](imgs/image-20250602233646666.png)

* 新接入的主机，在接收到ACKNOWLEDGE报文后，终于确认了自己的IP地址、子网掩码、默认网关、DNS服务器

![image-20250613202154341](imgs\image-20250613202154341.png)

* DHCP客户端发送 **DHCP REQUEST 报文续租**

* 如果拒绝续租，DHCP服务器可以发送**DHCP NACK报文否认**，收到后客户端会立即停用当前IP地址

* DHCP客户端可以随时发送 **DHCP RELEASE报文停租**，主动停用当前IP地址

* DHCP服务器**分配IP地址**、DHCP客户端**最后接受IP地址**时 ——

  都需要根据**ARP协议**进行检测，**确保IP地址未被占用**

![image-20250602233904970](imgs/image-20250602233904970.png)

### DHCP中继代理

![image-20250613203150964](imgs\image-20250613203150964.png)

* DHCP中继代理 —— 让**路由器**成为**DHCP中继代理**
  * 如果每个网络都配置DHCP服务器，成本过高
  * 客户端的DHCP广播无法穿透路由器到达另一个网络的DHCP服务器
  * 因此给路由器配置DHCP服务器IP地址，让其成为DHCP中继，允许可以通过DHCP广播消息
  * 这样，**客户端就可以跨网络向DHCP服务器申请IP地址**

![image-20250613204011485](imgs\image-20250613204011485.png)

## 2）域名系统 DNS

![image-20250613204652308](imgs\image-20250613204652308.png)

* **DNS** —— CS模式，负责 **域名<->IP地址** 的转换

* DNS 报文使用的传输层协议是 **UDP协议**

  DNS服务器的端口号是 **53**

### 层级域名

![image-20250613212604903](imgs\image-20250613212604903.png)

* 域名具有层次结构，**最右方**的域名是**顶级域名**

![image-20250613212838990](imgs\image-20250613212838990.png)

* 顶级域名有三类 —— 国家、通用机构、反向域

* 不同层级可能出现重名

  * 顶级域名中有com，表示公司

  * 我国的二级域名中有com，表示我国企业

![image-20250613213118803](imgs\image-20250613213118803.png)

* 域名是逻辑概念，不受物理空间限制

### 层级域名服务器

![image-20250613214309072](imgs\image-20250613214309072.png)

* **根域名服务器** —— 世界上有**13个**根域名服务器，每个根域名服务器都存储了**所有顶级域名服务器**的域名<->IP地址映射

  **顶级域名服务器** —— 存储其管辖的**二级**域名服务器的域名<->IP地址映射

  **权限域名服务器** —— 存储其管辖的**下一级**域名服务器，其管辖的所有**主机**的域名<->IP地址映射

* **本地域名服务器 = 默认域名服务器** —— 不属于上述划分，仅指代询问信息进入域名服务器系统的**门户**域名服务器

### 递归查询 VS 迭代查询

![image-20250613215416601](imgs\image-20250613215416601.png)

* **迭代查询是本地域名服务器在查询，而不是主机在查询**
* 解决迭代查询对本地域名服务器而言性能压力大的问题：
  * **主机 -> 本地域名服务器，使用递归查询**
  * **域名服务器之间的查询，使用迭代查询**

![image-20250613220622595](imgs\image-20250613220622595.png)

* 用户的主机、域名服务器中都广泛使用了**DNS缓存**

  作用：1. 提高查询效率	2. 减少DNS报文查询数量

* DNS缓存应该设置**计时器**，超时记录不能使用（域名<->IP地址的映射关系可能会发生改变）

![image-20250613220735559](imgs\image-20250613220735559.png)

![image-20250613221051071](imgs\image-20250613221051071.png)

* 如果恰好有对应DNS缓存，本地域名服务器可以不向外发送查询（有DNS缓存，查询次数最少是0）
* 本地域名服务器最先访问根域名服务器，然后才知道对应的顶级域名服务器的IP地址（先访问"/"，得知".com"）

## 3）文件传送协议 FTP

![image-20250614162533056](imgs\image-20250614162533056.png)

* FTP —— CS模式，在主机间传输文件

![image-20250614163003445](imgs\image-20250614163003445.png)

* **主动模式** —— 有数据要传输时，FTP主动请求建立数据通道
* FTP使用传输层的**TCP协议**，服务器**控制端口是21，数据端口是20**

![image-20250614163234248](imgs\image-20250614163234248.png)

* 被动模式 —— 有数据要传输时，客户端请求建立数据通道，FTP服务器被动打开数据通道
* 对FTP服务器：
  * 控制端口21
  * 主动模式的数据端口是20，被动模式随机
* 对FTP客户端：都随机

![image-20250614163522598](imgs\image-20250614163522598.png)

![image-20250614163615215](imgs\image-20250614163615215.png)

##  4）电子邮件

![image-20250615191537113](imgs\image-20250615191537113.png)

* 电子邮件 —— CS模式，发件人和收件人都有自己的邮件服务器

* 邮件发送协议 如 SMTP

  邮件读取协议 如 POP3、IMAP

* 电子邮件三构件：客户端、服务器端、协议

  **用户代理 = 电子邮件客户端**

### （1）简单邮件传送协议 SMTP

![image-20250615192156648](imgs\image-20250615192156648.png)

* SMTP协议使用传输层的TCP协议，服务器常用端口是25

![image-20250615191626981](imgs\image-20250615191626981.png)

![image-20250615192655483](imgs\image-20250615192655483.png)

* SMTP服务器不会立刻转发，而是定时检查是否有邮件，如果有就转发

* SMTP客户端是请求服务方，服务器端是提供服务方
  * 在发送方 -> 发送方邮件服务器时，发送方邮件服务器是服务器端
  * 在发送方邮件服务器 -> 接收方邮件服务器时，发送方邮件服务器是客户端

![image-20250615193027839](imgs\image-20250615193027839.png)

* **SMTP协议**，**不支持英文以外**的数据传输，而且有长度限制
* **MIME协议**是对它的扩充，使邮件能传输英文文字以外的内容

### （2）邮局协议 POP3

![image-20250615193308822](imgs\image-20250615193308822.png)

* POP3协议使用传输层的TCP协议，服务器常用端口是110

* 在SMTP协议里，客户端是数据的发送方

  在POP3协议里，客户端是数据的接收方

* POP3的两种工作方式

### （3）网际报文存取协议 IMAP

![image-20250615193532278](imgs\image-20250615193532278.png)

* IMAP和POP3协议一样，是另一种接收方从接收端邮件服务器接收消息时使用的协议

### （4）基于互联网的电子邮件

![image-20250615193726283](imgs\image-20250615193726283.png)

* HTTP -> SMTP -> HTTP

## 5）万维网

![image-20250615194135403](imgs\image-20250615194135403.png)

* 万维网使用**URL**作为统一资源定位符，用**HTTP协议**进行通信，数据格式是**HTML**
* HTTP协议是CS模式，常用服务器端口80

![image-20250615194317196](imgs\image-20250615194317196.png)

* HTTP协议的工作流程

![image-20250615194442129](imgs\image-20250615194442129.png)

* HTTP是**无状态**的，是指每次连接对于服务器来说都是全新的连接

  为了避免每次连接都要重新输入用户名、密码，浏览器用**Cookie**暂时存储这些信息，这样HTTP就可以假装“有状态”，有记忆了

* HTTP使用的传输层协议是**TCP**协议，但HTTP协议本身是**无连接**的

![image-20250615195121360](imgs\image-20250615195121360.png)

* HTTP连接方式 
  * 非持久连接	   —— 每次传消息，都要重新三次握手建立连接
  * 持久连接
    * 非流水线	—— 连接只需要建立一次，后续客户端请求一个内容，服务器发送一个内容
    * 流水线	    —— 连接只需要建立一次，后续客户端请求多个内容，服务器连续发送响应数据

![image-20250615195717779](imgs\image-20250615195717779.png)

* 两类HTTP报文 —— 

  * HTTP请求报文

    | 方法（操作） |             意义              |                             作用                             |
    | :----------: | :---------------------------: | :----------------------------------------------------------: |
    |     HEAD     | 请求读取由URL标识的信息的首部 |       服务器可对HTTP报文响应但不返回请求对象，用于调试       |
    |     GET      |    请求读取由URL标识的信息    |                      从服务器上获取数据                      |
    |     POST     |  给服务器添加信息（如注释）   |                       向服务器传递数据                       |
    |   CONNECT    |        用于代理服务器         | 将服务器作为代理，让服务器代替用户访问其他网页返回返回给用户 |

  * HTTP响应报文

    状态码，2xx成功，3xx重定向，4xx客户端错误，5xx服务器端错误

* CRLF是换行符，无论是请求消息还是响应消息，首部和主体间都要换行
